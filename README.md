# デモ機管理アプリ (Demo Unit Loan Management)

デモ機や医療機器の貸出・在庫管理を行うための Streamlit アプリケーションです。
在庫ごとのステータス管理、貸出・返却時の構成品チェック、写真記録、不具合（Issue）管理機能を備え、厳格なトレーサビリティを実現します。

## 主な機能

### 1. デザイン & UI
- **モダンでスタイリッシュなホワイトベースデザイン**: 視認性の高いフォントと、アクセントカラー（ディープブルー）を採用
- **カード型UI**: 各情報をカード形式で整理し、視認性を向上
- **Material Symbolsアイコン**: Google Material Symbolsを使用し、洗練された印象に統一

### 2. 在庫管理
- **カテゴリ管理**: 大分類（セルセーバー、IABP、電気メス等）ごとに機材を管理
- **統計情報**: カテゴリ内の機材ステータス集計（総台数、在庫あり、貸出中、要対応）を表示
- **ロット管理**: 機種ごとの実機（ロット/シリアル）ステータス管理
- **点検日管理**: 点検実施日・次回点検予定日の記録と表示

### 3. 貸出管理 (Checkout)
- **貸出登録**: 持出日、貸出先、目的、備考を記録。**青色のボタン**で直感的に操作可能
- **構成品チェック**: 機種や個体に応じたチェックリスト（OK/NG判定）
- **写真記録**: 貸出時の状態を写真で保存（必須）。カメラ撮影/ファイルアップロード対応
- **AssetmentNeo連携確認**: 外部システムへの登録確認チェック
- **異常検知**: NG項目がある場合、自動的に「要対応」ステータスへ移行

### 4. 返却管理 (Return)
- **返却登録**: 貸出履歴に基づく返却処理。**赤色のボタン**で直感的に操作可能
- **状態自動判定**: 返却時のチェック結果と既存の不具合状況に基づき、ステータスを自動更新
- **汚れチェック**: 返却時の清掃確認チェック機能
- **写真・チェック**: 返却時も貸出時と同様に写真とチェックリストを必須化

### 5. 貸出返却履歴
- **詳細履歴表示**: 貸出・返却の履歴をタイムライン形式で表示
- **構成品チェック詳細**: 各履歴を展開することで、その時点での構成品チェック結果を確認可能
- **写真表示**: 履歴ごとに記録された写真を表示
- **持出者表示**: 誰が持ち出したか（またはチェックを担当したか）を明記

### 6. 不具合・取消管理
- **Issue管理**: 不具合の記録と解消（Resolve）フロー
- **取消機能 (Undo)**: 誤操作時のための貸出・返却取消機能

### 7. 通知機能
- **グループ通知**: 貸出/返却完了時に、カテゴリごとの通知グループメンバー全員へメール通知
- **Issue通知**: 不具合発生時に通知グループへ自動通知
- **個人通知**: 操作者本人への確認メール送信
- **通知ログ**: 送信履歴の記録と確認

### 8. マスタ管理
- **機種・構成品管理**: 管理者による機種や構成品の登録・編集・削除機能
- **構成品一括登録**: 複数の構成品を選択し、それぞれの数量を設定して一括登録可能
- **不足品管理（トグル式）**: 構成品一覧でトグルをOFFにすると不足品として登録。不足品は貸出・返却時のチェックリストから自動除外
- **カテゴリ表示/非表示**: カテゴリの可視性を制御
- **部署管理**: ユーザーを部署ごとに管理
- **データ初期化機能 (Admin Only)**: 全データを初期化する管理者機能

### 9. 設定・ユーザー管理
- **SMTP設定**: メール通知のためのSMTPサーバー設定
- **部署管理**: ユーザーをグループ化する部署の管理
- **ユーザー管理**: ユーザーの追加・削除・部署設定
- **パスワード変更**: ログイン中のユーザーが自分のパスワードを変更可能（サイドバーから操作）
- **パスワードリセット（Admin Only）**: 管理者が他のユーザーのパスワードをリセット可能（設定→ユーザー管理）
- **通知グループ**: カテゴリごとの通知先メンバー設定（個別追加/部署一括追加）
- **通知ログ**: 送信履歴の確認

### 10. 分析
- **稼働率分析**: 機器ごとの貸出稼働率を期間指定で計算

### 11. 写真データ管理
- **自動クリーンアップ**: Supabase Storage上のセッション写真が2000枚を超えた場合、古いものから自動削除
- **貸出中写真の保護**: 返却されていない（貸出中）の機材の写真は削除対象から除外
- **上限設定**: `SESSION_PHOTOS_LIMIT` 変数で上限枚数をカスタマイズ可能

## 技術スタック

| カテゴリ | 技術 |
|----------|------|
| Frontend/Backend | Python (Streamlit 1.30+) |
| Database | SQLite (ローカル) または Supabase (クラウド) |
| 認証 | bcrypt (パスワードハッシュ化) |
| UI Styling | Custom CSS (`src/styles.py`), Material Symbols Rounded |
| 画像処理 | Pillow (WebP圧縮対応) |
| データベース切替 | 環境変数による自動切替（SQLite ↔ Supabase）|

## ディレクトリ構成
```
├── app.py                    # メインアプリケーション
├── src/
│   ├── views/                # 画面UIコンポーネント
│   │   ├── home.py           # ホーム画面
│   │   ├── loan.py           # 貸出登録画面
│   │   ├── return_view.py    # 返却登録画面
│   │   ├── master.py         # マスタ管理画面（構成品一括登録・不足品管理）
│   │   ├── master_category.py # カテゴリ設定画面
│   │   ├── settings.py       # 設定画面（SMTP、ユーザー、通知グループ）
│   │   ├── analytics.py      # 分析画面
│   │   ├── login.py          # ログイン画面
│   │   └── setup.py          # 初期セットアップ画面
│   ├── database.py           # データベースディスパッチャー（SQLite/Supabase自動切替）
│   ├── database_sqlite.py    # SQLiteデータベース操作
│   ├── database_supabase.py  # Supabaseデータベース操作
│   ├── logic.py              # ビジネスロジック・通知処理
│   ├── auth.py               # 認証機能
│   ├── storage.py            # ストレージ操作（ローカル/Supabase Storage）
│   ├── styles.py             # グローバルCSS定義
│   └── ui.py                 # 共通UIコンポーネント
├── data/
│   ├── app.db                # SQLiteデータベース（ローカルモード時）
│   └── uploads/              # アップロード画像
├── docs/
│   ├── DEPLOYMENT_MANUAL.md  # Streamlit Cloudデプロイ手順
│   └── SUPABASE_SETUP.md     # Supabaseセットアップ手順
├── scripts/
│   └── supabase_schema.sql   # Supabase用スキーマ
├── .streamlit/
│   ├── config.toml           # Streamlit設定
│   └── secrets.toml          # Supabase接続情報（Git管理外）
├── Start_App.bat             # アプリ起動用バッチファイル
├── install_deps.bat          # 依存関係インストール用
└── requirements.txt          # Python依存関係
```

## セットアップと実行

### 必要要件
- Python 3.10以上

### 初期設定 (初回のみ)

1. **依存関係のインストール**:
   ```powershell
   install_deps.bat
   ```
   または
   ```powershell
   pip install -r requirements.txt
   ```

### アプリケーションの起動

#### 方法1: バッチファイル（推奨）
以下のバッチファイルをダブルクリックしてください。
```
Start_App.bat
```
自動的にサーバーが立ち上がり、ブラウザが開きます。

#### 方法2: コマンドライン
```powershell
streamlit run app.py
```

ブラウザで `http://localhost:8501` にアクセスします。

## 初回起動

初回起動時は**管理者アカウントの作成画面**が表示されます。
- メールアドレス、氏名、パスワードを入力して管理者アカウントを作成してください。
- 作成後、そのアカウントでログインできます。

## データベースモード

### ローカルモード（SQLite）
デフォルトでは、`data/app.db` にSQLiteデータベースが作成されます。
セットアップは不要で、すぐに使用できます。

### クラウドモード（Supabase）
Supabaseを使用する場合は、`.streamlit/secrets.toml` に以下を設定してください：

```toml
SUPABASE_URL = "https://your-project-id.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

詳細は [docs/SUPABASE_SETUP.md](docs/SUPABASE_SETUP.md) を参照してください。

> アプリケーションは自動的に環境変数を検出し、SQLiteかSupabaseかを判定します。

### SharePoint同期フォルダモード（推奨）

社内サーバーまたはPCでアプリを実行し、データをSharePoint同期フォルダに保存する構成です。
Supabaseを使用せず、SQLiteデータベースを使用しながらOneDrive同期経由でSharePointにデータをバックアップします。

**メリット:**
- 既存のSQLite実装をそのまま使用
- SharePointにデータを保存（社内ルール準拠）
- クラウドバックアップ自動化

**セットアップ:**
1. SharePointサイトに `DemoLoan/data` フォルダを作成
2. OneDrive同期クライアントで同期設定
3. `Start_App_SharePoint.bat` のパスを実際の環境に合わせて修正
4. バッチファイルをダブルクリックして起動

```batch
REM 環境変数例
set DEMO_LOAN_DB_PATH=C:\Users\ユーザー名\OneDrive - 会社名\SharePoint\DemoLoan\data\app.db
set DEMO_LOAN_UPLOAD_DIR=C:\Users\ユーザー名\OneDrive - 会社名\SharePoint\DemoLoan\data\uploads
```

**同時アクセス対策:**
- WALモード: SQLiteのWrite-Ahead Loggingモードを有効化し、同時読み書きに対応
- リトライロジック: データベースロック時は自動的にリトライ
- 運用ルール: 可能な限り同じ機材の操作は1人が担当

## クラウドデプロイ

### Streamlit Cloud
1. GitHubリポジトリをStreamlit Cloudに接続
2. Secretsに `SUPABASE_URL` と `SUPABASE_KEY` を設定
3. デプロイ

詳細は [docs/DEPLOYMENT_MANUAL.md](docs/DEPLOYMENT_MANUAL.md) を参照してください。

## ユーザー権限

| 権限 | 説明 |
|------|------|
| admin | 全機能にアクセス可能（マスタ管理、設定、データ初期化） |
| user | 貸出・返却操作、履歴閲覧 |
| related | 関連業者向け（限定的なアクセス） |

## セキュリティ

- **パスワード**: bcryptでハッシュ化して保存
- **パスワード変更**: ユーザーがサイドバーから自分のパスワードを変更可能（現在のパスワード入力必須）
- **パスワードリセット**: 管理者が「設定」→「ユーザー管理」から他ユーザーのパスワードをリセット可能
- **APIキー**: `.streamlit/secrets.toml` に保存し、`.gitignore` で除外
- **セッション管理**: Streamlitのセッションステートを使用

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-27 | 機種一覧UIの視認性向上（機種名の区切り線スタイル改善、青アクセントカラー適用）、機種リストのソート機能追加（機種名順→ロット番号順） |
| 2026-01-26 | パフォーマンス改善（N+1クエリ修正、リトライデコレータ追加）、機種選択UIの安定性向上、構成品検索のEnterキー対応改善 |
| 2026-01-26 | 構成品一括登録機能追加、トグル式不足品管理機能追加、不足品の貸出・返却チェックリスト自動除外機能追加 |
| 2026-01-25 | 貸出返却履歴の表示不具合修正（重複表示の解消）、モバイル表示時のサイドバー挙動改善 |
| 2026-01-22 | コードレビュー改善（写真クリーンアップのバックグラウンド実行、SMTP設定共通化、例外処理改善、UX改善） |
| 2026-01-22 | 写真データ自動削除機能追加（2000枚超過時に古いものから自動削除、貸出中の写真は保護） |
| 2026-01-21 | 管理者用パスワードリセット機能追加（他ユーザーのパスワードを管理者がリセット可能） |
| 2026-01-21 | パスワード変更機能追加、Supabase接続設定更新 |
| 2026-01-21 | コードレビュー＆リファクタリング（SQLite直接使用修正、キャッシュTTL統一、重複コード削除） |
| 2026-01-18 | Supabase統合エラー修正 |
| 2026-01-17 | 貸出/返却時の通知グループへのグループ通知機能を追加 |
| 2026-01-12 | メール通知機能の改善、履歴写真表示機能追加、点検日表示機能追加 |
| 2026-01-10 | UI改善、データリセット機能追加 |
| 2025-12-28 | 初期リリース |

## ライセンス

このプロジェクトは社内利用を目的としています。

## サポート

問題が発生した場合は、以下を確認してください：
1. `data/app.db` が存在するか（SQLiteモード時）
2. `.streamlit/secrets.toml` にSupabase設定が正しいか（クラウドモード時）
3. Python依存関係がインストールされているか
4. アプリを再起動してみる（`Ctrl+C` で停止後、再度 `Start_App.bat` を実行）
