# 機材貸出管理システム (Demo Unit Loan Management)

デモ機や医療機器の貸出・在庫管理を行うための Streamlit アプリケーションです。
在庫ごとのステータス管理、貸出・返却時の構成品チェック、写真記録、不具合（Issue）管理機能を備え、厳格なトレーサビリティを実現します。

## 主な機能

### 1. 在庫管理
- カテゴリ > 機種 > ロット の階層で機器を管理
- 各ロットのステータス管理（在庫あり、貸出中、要対応）
- ロットごとの構成品カスタマイズ（個体差分）

### 2. マスタ管理
- 管理者権限による機種・構成品の登録・編集
- ブレークダウン/セット品に対応したテンプレート管理

### 3. 貸出管理 (Checkout)
- **貸出登録**: 持出日、貸出先、目的を記録
- **構成品チェック**: 機種や個体に応じたチェックリスト（OK/NG）
- **写真記録**: 貸出時の状態を写真で保存（必須）
- **異常検知**: NG項目がある場合、自動的に「要対応」ステータスへ移行し、貸出禁止ロックがかかります

### 4. 返却管理 (Return)
- **返却登録**: 貸出履歴に基づく返却処理（貸出中のみ可能）
- **状態自動判定**: 返却時のチェック結果と既存の不具合状況に基づき、自動的に「在庫あり」または「要対応」にステータスを更新
- **写真・チェック**: 返却時も貸出時と同様に写真とチェックリストを必須化

### 5. 不具合・取消管理 (Issue & Cancellation)
- **不具合解消**: 修理や対応が完了したIssueを「解決済み」にし、ユニットを貸出可能状態へ復帰
- **取消機能 (Undo)**: 誤って登録した貸出・返却を取り消す機能（論理削除）。取消操作に合わせてユニットの状態も整合性を保ったままロールバックされます

### 6. 通知・分析 (Notification & Analytics)
- **アラート通知**: 不具合（NG）発生時に、カテゴリごとに関連する担当者へ自動で通知ログを記録（SMTP設定時はメール送信も可能）
- **稼働率分析**: ユニットごとの稼働率を期間指定で計算・表示。定義に基づいた厳密な日数計算（同日貸出=1日、期間またぎ対応）
- **ダッシュボード**: ホーム画面で在庫・貸出中・要対応の件数をリアルタイム表示し、異常を即座に把握可能

## 技術スタック
- **Frontend/Backend**: Python (Streamlit)
- **Database**: SQLite (`data/app.db`)
- **Environment**: Windows 11 (PowerShell)

## ディレクトリ構成
- `src/`: ソースコード
  - `views/`: 画面UIコンポーネント (Home, Master, Loan, Return)
  - `database.py`: データベース操作・スキーマ定義
  - `logic.py`: 状態遷移・不具合判定などのビジネスロジック
  - `auth.py`: 認証関連
- `data/`: データ保存先
  - `uploads/`: アップロードされた画像ファイル（貸出/返却ごとにディレクトリ分割）
- `.venv/`: 仮想環境（ローカル）

## セットアップと実行

### 必要要件
- Python 3.10+

### インストール (Windows)
付属のバッチファイルを使用すると簡単です。

1. **初期セットアップ**:
   ```powershell
   install_deps.bat
   ```
   仮想環境の作成とライブラリのインストールが行われます。

### アプリケーションの起動
以下のバッチファイルをダブルクリックするか、ターミナルで実行してください。
```powershell
run_app.bat
```

または手動で:
```powershell
& ".venv\Scripts\streamlit" run app.py
```

ブラウザが自動的に開き、[http://localhost:8501](http://localhost:8501) にアクセスできます。

## 開発・検証
各フェーズごとの検証用スクリプトが含まれています。
- `verify_phase0.py`: 基本認証・DB基本機能のテスト
- `verify_phase1.py`: マスタ管理・在庫管理のテスト
- `verify_phase2.py`: 貸出プロセス、NG時のIssue作成テスト
- `verify_phase3.py`: 返却プロセス、ステータス再計算のテスト
- `verify_phase4.py`: Issue解消、貸出/返却取消、整合性維持のテスト
- `verify_phase5.py`: 通知ログ、稼働率計算ロジック、ダッシュボード集計のテスト
